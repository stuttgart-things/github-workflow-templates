---
name: Ansible collection build
on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        default: dagger
      collection-directory:
        required: true
        type: string
      branch-name:
        required: false
        default: main
        type: string
      dagger-module-version:
        required: false
        type: string
        default: v0.2.0
      environment-name:
        required: false
        type: string
        default: k8s

jobs:
  collection-build:
    name: Collection Build
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment-name }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: '0'
          ref: ${{ inputs.branch-name }}

      - name: Init Collection structure
        uses: dagger/dagger-for-github@v7
        with:
          version: "0.15.2"
          verb: call
          args: run-collection-build-pipeline --src ${{ inputs.collection-directory }} --progress plain export --path=/tmp/build
          module: github.com/stuttgart-things/dagger/ansible@${{ inputs.dagger-module-version }}

      - name: List Collection
        run: ls -lta /tmp/build
