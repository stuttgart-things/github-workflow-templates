---
name: Repository Linting
on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        default: ubuntu-latest
      app-directory:
        required: false
        type: string
        default: "./"
      output-file:
        required: false
        type: string
        default: "/tmp/repo-findings.txt"
      continue-error:
        required: false
        type: string
        default: "true"
      branch-name:
        required: false
        type: string
        default: main
      dagger-version:
        required: false
        type: string
        default: "0.19.3"
      dagger-module-version:
        required: false
        type: string
        default: v1.15.0
      environment-name:
        required: false
        type: string
        default: linting
      artifact-retention-days:
        required: false
        type: number
        default: 30

permissions:
  contents: read

jobs:
  lint-repository:
    name: Repository Linting
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment-name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch-name }}

      - name: Run repository linting
        uses: dagger/dagger-for-github@v8.2.0
        with:
          version: ${{ inputs.dagger-version }}
          verb: call
          module: github.com/stuttgart-things/blueprints/repository-linting@${{ inputs.dagger-module-version }}
          args: validate-multiple-technologies --src ${{ inputs.app-directory }} export --path ${{ inputs.output-file }}

      - name: Display linting results
        if: always()
        run: |
          if [ -f ${{ inputs.output-file }} ]; then
            echo "==> Repository Linting Results"
            cat ${{ inputs.output-file }}

            # Check if there are any findings
            if [ -s ${{ inputs.output-file }} ]; then
              echo ""
              echo "âš ï¸  Linting findings detected. Please review the output above."
            else
              echo "âœ… No linting issues found"
            fi
          else
            echo "âŒ Linting output file not found"
            exit 1
          fi

      - name: Upload linting results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: linting-results
          path: ${{ inputs.output-file }}
          retention-days: ${{ inputs.artifact-retention-days }}

      - name: Add results to summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” Repository Linting Results

          EOF

          if [ -f ${{ inputs.output-file }} ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat ${{ inputs.output-file }} >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo 'âŒ No results file generated' >> $GITHUB_STEP_SUMMARY
          fi
